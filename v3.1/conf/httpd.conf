ServerName        localhost
ServerAdmin       root@localhost
ServerRoot        /etc/apache2
User              www-data
Group             root

ServerTokens      Prod
UseCanonicalName  On
TraceEnable       Off

Timeout           5
MaxRequestWorkers ${HTTPD_MAX_REQUEST_WORKERS}
ServerLimit       ${HTTPD_SERVER_LIMIT}

Listen            ${PORT}

LoadModule        mpm_event_module        /usr/lib/apache2/modules/mod_mpm_event.so
LoadModule        rewrite_module          /usr/lib/apache2/modules/mod_rewrite.so
LoadModule        headers_module          /usr/lib/apache2/modules/mod_headers.so

LoadModule        authn_core_module       /usr/lib/apache2/modules/mod_authn_core.so
LoadModule        authz_core_module       /usr/lib/apache2/modules/mod_authz_core.so

#LoadModule        ssl_module              /usr/lib/apache2/modules/mod_ssl.so

LoadModule        unique_id_module        /usr/lib/apache2/modules/mod_unique_id.so
LoadModule        mime_module             /usr/lib/apache2/modules/mod_mime.so
LoadModule        include_module          /usr/lib/apache2/modules/mod_include.so


LoadModule        alias_module            /usr/lib/apache2/modules/mod_alias.so

LoadModule        security2_module        /usr/lib/apache2/modules/mod_security2.so

LoadModule        proxy_module            /usr/lib/apache2/modules/mod_proxy.so
LoadModule        proxy_http_module       /usr/lib/apache2/modules/mod_proxy_http.so

LoadModule        remoteip_module         /usr/lib/apache2/modules/mod_remoteip.so

TypesConfig       /etc/mime.types

ErrorLogFormat          "[%{cu}t] [%-m:%-l] %-a %-L %M"
LogFormat               "%a %l %u [%{%Y-%m-%d %H:%M:%S}t.%{usec_frac}t] \"%r\" %>s %b \
\"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "{ \"apache-access\": { \"remoteHost\":\"%a\", \"countryCode\":\"%{GEOIP_COUNTRY_CODE}e\", \"username\":\"%u\", \"timestamp\":\"%{%Y-%m-%d %H:%M:%S}t.%{usec_frac}t\", \"requestLine\":\"%r\", \"status\":%>s, \"responseBodySize\":%B, \
\"referer\":\"%{Referer}i\", \"userAgent\":\"%{User-Agent}i\", \"serverName\":\"%v\", \"serverIP\":\"%A\",\"serverPort\":%p, \"handler\":\"%R\", \"workerRoute\":\"%{BALANCER_WORKER_ROUTE}e\", \"tcpStatus\":\"%X\", \"cookie\":\"%{cookie}n\", \
\"uniqueID\":\"%{UNIQUE_ID}e\", \"requestBytes\":%I, \"responseBytes\":%O,\"compressionRatio\":\"%{ratio}n%%\", \
\"requestDuration\":%D,\"modsecTimeIn\":%{ModSecTimeIn}e, \"applicationTime\":%{ApplicationTime}e, \"modsecTimeOut\":%{ModSecTimeOut}e, \
\"modsecAnomalyScoreIn\":%{ModSecAnomalyScoreIn}e, \"modsecAnomalyScoreOut\":%{ModSecAnomalyScoreOut}e } }" extendedjson

LogFormat "%a %{GEOIP_COUNTRY_CODE}e %u [%{%Y-%m-%d %H:%M:%S}t.%{usec_frac}t] \"%r\" %>s %b \
\"%{Referer}i\" \"%{User-Agent}i\" %v %A %p %R %{BALANCER_WORKER_ROUTE}e %X \"%{cookie}n\" \
%{UNIQUE_ID}e %I %O %{ratio}n%% \
%D %{ModSecTimeIn}e %{ApplicationTime}e %{ModSecTimeOut}e \
%{ModSecAnomalyScoreIn}e %{ModSecAnomalyScoreOut}e" extended

LogFormat "{ \"perfdata\": { \"timestamp\":\"[%{%Y-%m-%d %H:%M:%S}t.%{usec_frac}t]\", \"uniqueID\":\"%{UNIQUE_ID}e\", \"requestDuration\":\"%D\", \
\"PerfModSecInbound\":\"%{TX.perf_modsecinbound}M\", \
\"PerfAppl\":\"%{TX.perf_application}M\" \
\"PerfModSecOutbound:\":\"%{TX.perf_modsecoutbound}M\", \
\"TS-Phase1\":\"%{TX.ModSecTimestamp1start}M-%{TX.ModSecTimestamp1end}M\", \
\"TS-Phase2\":\"%{TX.ModSecTimestamp2start}M-%{TX.ModSecTimestamp2end}M\", \
\"TS-Phase3\":\"%{TX.ModSecTimestamp3start}M-%{TX.ModSecTimestamp3end}M\", \
\"TS-Phase4\":\"%{TX.ModSecTimestamp4start}M-%{TX.ModSecTimestamp4end}M\", \
\"TS-Phase5\":\"%{TX.ModSecTimestamp5start}M-%{TX.ModSecTimestamp5end}M\", \
\"Perf-Phase1\":\"%{PERF_PHASE1}M\", \
\"Perf-Phase2\":\"%{PERF_PHASE2}M\", \
\"Perf-Phase3\":\"%{PERF_PHASE3}M\", \
\"Perf-Phase4\":\"%{PERF_PHASE4}M\", \
\"Perf-Phase5\":\"%{PERF_PHASE5}M\", \
\"Perf-ReadingStorage\":\"%{PERF_SREAD}M\", \
\"Perf-WritingStorage\":\"%{PERF_SWRITE}M\", \
\"Perf-GarbageCollection\":\"%{PERF_GC}M\", \
\"Perf-ModSecLogging\":\"%{PERF_LOGGING}M\", \
\"Perf-ModSecCombined\":\"%{PERF_COMBINED}M\ } }"  perflogjson

LogLevel                notice
ErrorLog                /modsecurity/data/log/error.log
CustomLog               /modsecurity/data/log/access.log extendedjson
CustomLog               /modsecurity/data/log/perf.log perflogjson env=write_perflog

RemoteIPHeader X-Forwarded-For
RemoteIPInternalProxy 10.1.0.0/16


#===============================#
#== ModSec Base Configuration ==#
#===============================#

SecRuleEngine ${RULE_ENGINE}
SecRequestBodyAccess ${REQ_BODY_ACCESS}
SecRequestBodyLimit ${REQ_BODY_LIMIT}
SecRequestBodyNoFilesLimit ${REQ_BODY_NOFILES_LIMIT}
SecResponseBodyAccess ${RESP_BODY_ACCESS}
SecResponseBodyLimit ${RESP_BODY_LIMIT}
SecPcreMatchLimit ${PCRE_MATCH_LIMIT}
SecPcreMatchLimitRecursion ${PCRE_MATCH_LIMIT_RECURSION}
SecTmpDir /modsecurity/tmp
SecDataDir /modsecurity/data
SecUploadDir /modsecurity/upload
SecUploadFileMode 0644
SecTmpSaveUploadedFiles On

SecDebugLog /dev/stdout
SecDebugLogLevel 0

SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABEFHIJZ

SecAuditLogType Concurrent
SecAuditLog /modsecurity/data/log/audit.log
SecAuditLogStorageDir /modsecurity/data/audit


SecDefaultAction "phase:1,pass,log,tag:'${MODSEC_TAG}'"

# == ModSec Rule ID Namespace Definition
# Service-specific before Core-Rules:    10000 -  49999
# Service-specific after Core-Rules:     50000 -  79999
# Locally shared rules:                  80000 -  99999
#  - Performance:                        90000 -  90199
# Recommended ModSec Rules (few):       200000 - 200010
# OWASP Core-Rules:                     900000 - 999999


# === ModSec timestamps at the start of each phase (ids: 90000 - 90009)

SecAction "id:90000,phase:1,nolog,pass,setvar:TX.ModSecTimestamp1start=%{DURATION}"
SecAction "id:90001,phase:2,nolog,pass,setvar:TX.ModSecTimestamp2start=%{DURATION}"
SecAction "id:90002,phase:3,nolog,pass,setvar:TX.ModSecTimestamp3start=%{DURATION}"
SecAction "id:90003,phase:4,nolog,pass,setvar:TX.ModSecTimestamp4start=%{DURATION}"
SecAction "id:90004,phase:5,nolog,pass,setvar:TX.ModSecTimestamp5start=%{DURATION}"

# Perform geolocation
SecRule REMOTE_ADDR "@geoLookup" "id:90200,phase:1,pass,t:none,nolog"
SecRule GEO:COUNTRY_CODE "@unconditionalMatch" "id:90201,phase:1,pass,t:none,nolog,setenv:GEOIP_COUNTRY_CODE=%{MATCHED_VAR}"

# SecRule REQUEST_FILENAME "@beginsWith /" \
#    "id:90005,phase:5,t:none,nolog,noauditlog,pass,setenv:write_perflog"

# === ModSec Recommended Rules (in modsec src package) (ids: 200000-200010)

SecRule REQUEST_HEADERS:Content-Type "text/xml" \
  "id:200000,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

SecRule REQUEST_HEADERS:Content-Type "application/json" \
  "id:200001,phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=JSON"

SecRule REQBODY_ERROR "!@eq 0" \
  "id:200002,phase:2,t:none,deny,status:400,log,\
  msg:'Failed to parse request body.',logdata:'%{reqbody_error_msg}',severity:2"

SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
  "id:200003,phase:2,t:none,log,deny,status:403, \
  msg:'Multipart request body failed strict validation: \
  PE %{REQBODY_PROCESSOR_ERROR}, \
  BQ %{MULTIPART_BOUNDARY_QUOTED}, \
  BW %{MULTIPART_BOUNDARY_WHITESPACE}, \
  DB %{MULTIPART_DATA_BEFORE}, \
  DA %{MULTIPART_DATA_AFTER}, \
  HF %{MULTIPART_HEADER_FOLDING}, \
  LF %{MULTIPART_LF_LINE}, \
  SM %{MULTIPART_MISSING_SEMICOLON}, \
  IQ %{MULTIPART_INVALID_QUOTING}, \
  IP %{MULTIPART_INVALID_PART}, \
  IH %{MULTIPART_INVALID_HEADER_FOLDING}, \
  FL %{MULTIPART_FILE_LIMIT_EXCEEDED}'"

SecRule TX:/^MSC_/ "!@streq 0" \
  "id:200005,phase:2,t:none,deny,status:500,\
  msg:'ModSecurity internal error flagged: %{MATCHED_VAR_NAME}'"


# === ModSec Core Rules Base Configuration (ids: 900000-900999)

Include    /etc/apache2/modsecurity.d/owasp-crs/crs-setup.conf

SecAction "id:900200,phase:1,pass,nolog,setvar:'tx.allowed_methods=GET HEAD POST OPTIONS DELETE PUT PROPFIND'"
SecAction "id:900220,phase:1,pass,nolog,setvar:'tx.allowed_request_content_type=application/x-www-form-urlencoded|multipart/form-data|text/xml|application/xml|application/x-amf|application/json'"
SecAction "id:900300,phase:1,pass,nolog,setvar:tx.max_num_args=${MODSEC_MAX_NUM_ARGS}"
SecAction "id:900310,phase:1,pass,nolog,setvar:tx.arg_name_length=${MODSEC_ARG_NAME_LENGTH}"
SecAction "id:900340,phase:1,pass,nolog,setvar:tx.max_file_size=100000000"
SecAction "id:900350,phase:1,pass,nolog,setvar:tx.combined_file_sizes=100000000"


# === ModSec Core Rules: Runtime Exclusion Rules (ids: 10000-49999)

#Include    /etc/apache2/modsecurity.d/runtime-exclusions/*.conf

# === Custom Rules Inclusion before ModSecurity Core Rules 

IncludeOptional    /modsecurity/rules/before-crs/*.conf


# === ModSecurity Core Rules Inclusion

Include    /etc/apache2/modsecurity.d/owasp-crs/rules/*.conf

# === Custom Rules Inclusion after ModSecurity Core Rules 

IncludeOptional    /modsecurity/rules/after-crs/*.conf


# === ModSec Core Rules: Startup Time Rules Exclusions

#Include    /etc/apache2/modsecurity.d/startup-exclusions/*.conf


# === ModSec timestamps at the end of each phase (ids: 90010 - 90019)

SecAction "id:90010,phase:1,pass,nolog,setvar:TX.ModSecTimestamp1end=%{DURATION}"
SecAction "id:90011,phase:2,pass,nolog,setvar:TX.ModSecTimestamp2end=%{DURATION}"
SecAction "id:90012,phase:3,pass,nolog,setvar:TX.ModSecTimestamp3end=%{DURATION}"
SecAction "id:90013,phase:4,pass,nolog,setvar:TX.ModSecTimestamp4end=%{DURATION}"
SecAction "id:90014,phase:5,pass,nolog,setvar:TX.ModSecTimestamp5end=%{DURATION}"


# === ModSec performance calculations and variable export (ids: 90100 - 90199)

SecAction "id:90100,phase:5,pass,nolog,\
  setvar:TX.perf_modsecinbound=%{PERF_PHASE1},\
  setvar:TX.perf_modsecinbound=+%{PERF_PHASE2},\
  setvar:TX.perf_application=%{TX.ModSecTimestamp3start},\
  setvar:TX.perf_application=-%{TX.ModSecTimestamp2end},\
  setvar:TX.perf_modsecoutbound=%{PERF_PHASE3},\
  setvar:TX.perf_modsecoutbound=+%{PERF_PHASE4},\
  setenv:ModSecTimeIn=%{TX.perf_modsecinbound},\
  setenv:ApplicationTime=%{TX.perf_application},\
  setenv:ModSecTimeOut=%{TX.perf_modsecoutbound},\
  setenv:ModSecAnomalyScoreIn=%{TX.anomaly_score},\
  setenv:ModSecAnomalyScoreOut=%{TX.outbound_anomaly_score}"


<Virtualhost *:8080>
  ServerName ${SERVER_NAME}

  RequestHeader set X-Forwarded-Proto "https"
  RequestHeader set X-Real-IP %{REMOTE_ADDR}s
  RequestHeader set X-Unique-ID %{UNIQUE_ID}e

  ## Proxy rules
  ProxyRequests Off
  ProxyPreserveHost On
  ProxyErrorOverride Off

  ProxyTimeout ${PROXY_TIMEOUT}

  Alias "/errors" "/opt/app-root/errors"

  ErrorDocument 502 /errors/maintenance.html
  ErrorDocument 503 /errors/maintenance.html
  ErrorDocument 503 /errors/maintenance.html
  ErrorDocument 504 /errors/maintenance.html
  ProxyPass /errors/ !
  ProxyPassReverse /errors !
  ProxyPass / ${BACKEND} disablereuse=on
  ProxyPassReverse / ${BACKEND}

</VirtualHost>
